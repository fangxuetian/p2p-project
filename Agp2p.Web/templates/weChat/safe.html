<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>安全中心</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link type="text/css" rel="stylesheet" href="<%templateskin%>/css/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="<%templateskin%>/css/safe-center.css">
    <link type="text/css" rel="stylesheet" href="<%templateskin%>/css/footer.css">
    <link type="text/css" rel="stylesheet" href="<%templateskin%>/css/common.css">
    <script src="<%templateskin%>/js/jquery-2.1.4.min.js"></script>
    <script src="<%templateskin%>/js/bootstrap.min.js"></script>

    <script>
        /*rem的相对单位定义*/
        $("html").css("font-size", $(window).width() * 0.9 / 20);

        /*切换验证码*/
        function ToggleCode(obj, codeurl) {
            $(obj).attr("src", codeurl + "?time=" + Math.random());
            return false;
        }
        function verify_email(btn, email) {
            var originalEmail = "{userModel.email}";
            email = $.trim(email);
            if (email === "") {
                alert("请先填写邮箱");
                return false;
            }
            if (email === originalEmail) {
                alert("请填写另外一个邮箱");
                return false;
            }
            var disabledBtn = $(btn);
            var originalText = disabledBtn.text();
            disabledBtn.text("正在发送…").attr('disabled', 'disabled').attr('style', 'background-color: gray');

            $.getJSON('/tools/email_verify.ashx?action=sendVerifyEmailViaCode&email=' + email, function (data) {
                disabledBtn.removeAttr('disabled').removeAttr('style').text(originalText);
                alert(data.msg);
            }).fail(function (jqXHR) {
                disabledBtn.removeAttr('disabled').removeAttr('style').text(originalText);
                alert(jqXHR.responseJSON.msg);
            });
            return false;
        }
        function bindEmail(code) {
            $.ajax({
                dataType: "json",
                url: '/tools/email_verify.ashx?action=verifyEmail&code=' + code,
                success: function (data) {
                    alert(data.msg);
                    location.reload(); // 验证手机成功，刷新页面
                },
                error: function (jqXHR) {
                    alert(jqXHR.responseJSON.msg);
                }
            });
        }
        function send_mobile_verify_code(btn, mobile, picCode) {
            var originalMobile = "{userModel.mobile}";
            mobile = $.trim(mobile);
            if (picCode === "") {
                alert("请先填写图形验证码");
                return false;
            }
            if (mobile === "") {
                alert("请先填写手机号码");
                return false;
            }
            if (mobile === originalMobile) {
                alert("请填写另外一个手机号码");
                return false;
            }
            var disabledBtn = $(btn);
            var originalText = disabledBtn.text();
            disabledBtn.text("正在发送…").attr('disabled', 'disabled');

            $.getJSON('/tools/mobile_verify.ashx?act=sendCodeForBindMobile&mobile=' + mobile + '&picCode=' + picCode, function (data) {
                disabledBtn.removeAttr('disabled').text(originalText);
                alert(data.msg);
            }).fail(function (jqXHR) {
                disabledBtn.removeAttr('disabled').text(originalText);
                alert(jqXHR.responseJSON.msg);
            });
            return false;
        }
        function set_mobile(btn, verifyCode) {
            verifyCode = $.trim(verifyCode);
            if (verifyCode === "") {
                alert("请先填写验证码");
                return false;
            }
            var disabledBtn = $(btn);
            var originalText = disabledBtn.text();
            disabledBtn.text("正在发送…").attr('disabled', 'disabled').attr('style', 'background-color: gray');

            $.getJSON('/tools/mobile_verify.ashx?act=verifyForBindMobile&verifyCode=' + verifyCode, function (data) {
                disabledBtn.removeAttr('disabled').removeAttr('style').text(originalText);
                alert(data.msg);
                location.reload(); // 验证手机成功，刷新页面
            }).fail(function (jqXHR) {
                disabledBtn.removeAttr('disabled').removeAttr('style').text(originalText);
                alert(jqXHR.responseJSON.msg);
            });
            return false;
        }
        function checkIdentifyAndSubmit(trueName, idCard) {
            var name = $.trim(trueName);
            var idCardNumber = $.trim(idCard);

            if (name === "") {
                alert("请填写姓名");
                return false;
            } else if (idCardNumber === "") {
                alert("请填写身份证号码");
                return false;
            }

            if (confirm("身份资料填写后则不能再修改，是否确认？")) {
                $.post('/tools/submit_ajax.ashx?action=bind_idcard', {
                    idCardNumber: idCardNumber,
                    trueName: name
                }, function (data) {
                    alert(data.msg);
                    if (data.status === 1)
                        location.reload();
                }, "json").fail(function (jqXHR) {
                    alert(jqXHR.responseText);
                });
            }
            return false;
        }
        function modifyPassword(btn, oldPwd, newPwd, newPwd2) {
            var oldPwdVal = $.trim(oldPwd);
            var newpwdVal = $.trim(newPwd);
            var newpwdrpVal = $.trim(newPwd2);
            if (oldPwdVal === "" || newpwdVal === "" || newpwdrpVal === "") {
                alert("请先填写好表单");
                return;
            }
            if (newpwdVal !== newpwdrpVal) {
                alert("两次输入的新密码不一样");
                return;
            }
            var disabledBtn = $(btn);
            var originalText = disabledBtn.text();
            disabledBtn.text("正在提交…").attr('disabled', 'disabled').attr('style', 'background-color: gray');
            $.post('/tools/submit_ajax.ashx?action=user_password_edit', { txtOldPassword: oldPwdVal, txtPassword: newpwdVal }, function (data) {
                alert(data.msg);
                disabledBtn.removeAttr('disabled').removeAttr('style').text(originalText);
                location.reload();
            }, "json");
        }
        function setTradePwd(btn, newTradePwd, newTradePwd2) {
            var tradepwdVal = $.trim(newTradePwd);
            var tradepwdrpVal = $.trim(newTradePwd2);

            if (tradepwdVal !== tradepwdrpVal) {
                alert("两次输入的交易密码不同");
                return;
            }

            var disabledBtn = $(btn);
            var originalText = disabledBtn.text();
            disabledBtn.text("正在发送…").attr('disabled', 'disabled').attr('style', 'background-color: gray');
            $.post('/tools/trade_pwd.ashx', { action: "modify", originalTransactPassword: "", newTransactPassword: tradepwdVal }, function (data) {
                disabledBtn.removeAttr('disabled').removeAttr('style').text(originalText);
                alert(data.msg);
                location.reload(); // 设置交易密码成功，刷新页面
            }, "json").fail(function (jqXHR) {
                disabledBtn.removeAttr('disabled').removeAttr('style').text(originalText);
                alert(jqXHR.responseJSON.msg);
            });
        }
        function modTradePwd(btn, oldTradePwd, newTradePwd, newTradePwd2) {
            var oldtpwdVal = $.trim(oldTradePwd);
            var newtpwdVal = $.trim(newTradePwd);
            var newtpwdrpVal = $.trim(newTradePwd2);

            if (newtpwdVal !== newtpwdrpVal) {
                alert("两次输入的交易密码不同");
                return;
            }

            var disabledBtn = $(btn);
            var originalText = disabledBtn.text();
            disabledBtn.text("正在发送…").attr('disabled', 'disabled').attr('style', 'background-color: gray');
            $.post('/tools/trade_pwd.ashx', { action: "modify", originalTransactPassword: oldtpwdVal, newTransactPassword: newtpwdVal }, function (data) {
                alert(data.msg);
                disabledBtn.removeAttr('disabled').removeAttr('style').text(originalText);
                location.reload(); // 修改交易密码成功，刷新页面
            }, "json").fail(function (jqXHR) {
                disabledBtn.removeAttr('disabled').removeAttr('style').text(originalText);
                alert(jqXHR.responseJSON.msg);
            });
        }
        function forgotTradePassword() {
            if (confirm("是否确认重置交易密码？")) {
                $.post('/tools/trade_pwd.ashx', { action: "reset" }, function (data) {
                    alert(data.msg);
                }, "json").fail(function (jqXHR) {
                    alert(jqXHR.responseJSON.msg);
                });
            }
        }
        $(function(){
            $("a.toggle-btn").click(function(){
                var current = $(this).siblings(".fold");
                current.toggle();
                $("div.fold").filter(function (index, elem) {
                    return current[0] !== elem;
                }).hide();
            });
        });
    </script>
</head>
<body>
<div class="safe-center-page">
    <div class="safe-center-body">
        <div class="group">
            <div class="email-approve">
                <span>邮箱认证</span>
                <a class="toggle-btn" href="javascript:;">修改</a>
                <div class="fold" style="display: none">
                    <p><%=string.IsNullOrWhiteSpace(userModel.email) ? "（未设置）" : userModel.email%></p>
                    <input id="email" class="input-l" type="text" placeholder="请输入新邮箱">
                    <button type="button" class="button-l long-btn" onclick="verify_email(this, $('#email').val())">提 交</button>
                    <input id="email-verify-code" class="input-l" type="text" placeholder="请输入邮箱验证码">
                    <button type="button" class="button-l long-btn" onclick="bindEmail($('#email-verify-code').val())">验 证</button>
                </div>
            </div>
        </div>

        <div class="group">
            <div class="phone-bind">
                <span>绑定手机</span>
                <a class="toggle-btn" href="javascript:;">修改</a>
                <div class="fold" style="display: none">
                    <p><%=string.IsNullOrWhiteSpace(userModel.mobile) ? "（未设置）" : userModel.mobile%></p>
                    <input id="phone" class="input-l" type="text" placeholder="请输入新的手机号码">
                    <input id="pic-code" class="input-s" type="text" placeholder="请输入图形验证码"/>
                    <span class="pic-code-span pic-code-box flex flex-center-wrapper">
                        <img style="cursor:pointer" src="{config.webpath}tools/verify_code.ashx" onclick="return ToggleCode(this, '{config.webpath}tools/verify_code.ashx');"/>
                    </span>
                    <input id="sms-code" class="input-s" type="text" placeholder="请输入短信验证码">
                    <button type="button" class="button-s right-small-btn" onclick="send_mobile_verify_code(this, $('input#phone').val(), $('input#pic-code').val())">获 取</button>
                    <button type="button" class="button-l long-btn" onclick="set_mobile(this, $('input#sms-code').val())">提 交</button>
                </div>
            </div>
        </div>

        <div class="group">
            <div class="user-approve">
                <span>实名认证</span>
                <a class="toggle-btn" href="javascript:;">设置</a>
                <div class="fold" style="display: none">
                    <input id="name" class="input-l" type="text" placeholder="请输入您的真实姓名" value="{userModel.real_name}">
                    <input id="ID" class="input-l" type="text" placeholder="请输入您的身份证号码" value="{userModel.id_card_number}">
                    <div class="tips"><span style="color: red">*</span>&nbsp;实名认证是您平台账户操作的重要凭证，若因盗用他人信息注册认证导致您的账户资金无法提现，平台除锁定该账户外，必要时将依法提交至执法部门处理！
                    </div>
                    <button type="button" class="button-l long-btn" onclick="checkIdentifyAndSubmit($('.user-approve input#name').val(), $('.user-approve input#ID').val())">提 交</button>
                </div>
                <script>
                    var trueName = $('.user-approve input#name');
                    if (trueName.val() !== "") {
                        // lock identity modify
                        trueName[0].readOnly = true;
                        $('.user-approve input#ID')[0].readOnly = true;
                        $('.user-approve button.long-btn').css('background-color', '#ccc').attr('onclick', 'alert("认证信息已锁定")');
                    }
                </script>
            </div>
        </div>

        <div class="group">
            <div class="login-pwd">
                <span>登录密码</span>
                <a class="toggle-btn" href="javascript:;">修改</a>
                <div class="fold" style="display: none">
                    <input id="oldPwd" class="input-l pwd" type="password" placeholder="请输入您的原密码">
                    <input id="newPwd" class="input-l pwd" type="password" placeholder="请输入您的新密码">
                    <input id="newPwd2" class="input-l pwd" type="password" placeholder="请再次输入您的新密码">
                    <div class="tips"><span style="color: red">*</span>为了您的账户安全，请定期更改登录密码，并确保登录密码设置与交易密码不同。</div>
                    <button type="button" class="button-l long-btn" onclick="modifyPassword(this, $('.login-pwd input#oldPwd').val(), $('.login-pwd input#newPwd').val(), $('.login-pwd input#newPwd2').val())">提 交</button>
                </div>
            </div>
        </div>

        <div class="group">
            <div class="trade-pwd">
                <span>交易密码</span>
                <a class="toggle-btn" href="javascript:;">修改</a>
                <div class="fold" style="display: none">
                    <input id="oldTradePwd" class="input-l pwd" type="password" placeholder="请输入您的原交易密码">
                    <input id="newTradePwd" class="input-l pwd" type="password" placeholder="请输入您新的交易密码">
                    <input id="newTradePwd2" class="input-l pwd" type="password" placeholder="请再次输入您新的交易密码">
                    <a class="forgot-pwd" href="javascript:;" onclick="forgotTradePassword()">忘记密码?</a>
                    <button type="button" class="button-l long-btn">提 交</button>
                </div>
                <script>
                    var haveTradePwd = <%= string.IsNullOrWhiteSpace(userModel.pay_password) ? "false" : "true"%>;
                    if (!haveTradePwd) {
                        $(".trade-pwd input#oldTradePwd").hide();
                        $(".trade-pwd .forgot-pwd").hide();
                    }
                    $(".trade-pwd .long-btn").click(function () {
                        if (!haveTradePwd) {
                            setTradePwd(this, $("#newTradePwd").val(), $("#newTradePwd2").val());
                        } else {
                            modTradePwd(this, $("#oldTradePwd").val(), $("#newTradePwd").val(), $("#newTradePwd2").val());
                        }
                    });
                </script>
            </div>
        </div>
    </div>
</div>
<script>var forceFooterKey = "settings";</script>
<%template src="_footer.html"%>
</body>
</html>