<%namespace "Agp2p.Core"%>
<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta content="{projectModel.seo_keywords}" name="keywords" />
    <meta content="{projectModel.seo_description}" name="description" />
    <title><%=string.IsNullOrEmpty(projectModel.seo_title) ? projectModel.title : projectModel.seo_title%></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link type="text/css" rel="stylesheet" href="<%templateskin%>/css/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="<%templateskin%>/css/common.css">
    <link type="text/css" rel="stylesheet" href="<%templateskin%>/css/receive-plan-detail.css">
    <link type="text/css" rel="stylesheet" href="<%templateskin%>/css/claims-photos.css">
    <link type="text/css" rel="stylesheet" href="<%templateskin%>/css/project-detail.css">
    <link type="text/css" rel="stylesheet" href="<%templateskin%>/css/invest-detail.css">
    <link type="text/css" rel="stylesheet" href="<%templateskin%>/css/invest-success.css">
    <link type="text/css" rel="stylesheet" href="<%templateskin%>/css/footer.css">
    <script src="<%templateskin%>/js/jquery-2.1.4.min.js"></script>
    <script src="<%templateskin%>/js/bootstrap.min.js"></script>
    <script src="<%templateskin%>/js/radialIndicator.min.js"></script>
    <script type="text/javascript" src="{config.webpath}scripts/lhgdialog/lhgdialog.js?skin=idialog"></script>

    <link type="text/css" rel="stylesheet" href="{config.webpath}scripts/fullpage/jquery.fullPage.css">
    <script type="text/javascript" src="{config.webpath}scripts/fullpage/jquery.fullPage.min.js"></script>

    <style>
        .inner-scrollable { /*fullPage 可滚动*/
            -webkit-overflow-scrolling: touch;
            overflow-y: scroll;
            height: 100%;
        }
        /*隐藏滚动条*/
        .inner-scrollable::-webkit-scrollbar {width: 0 !important;}

        /*投资记录*/
        div.invest-record-page {padding: 0 5%;}
        div.record-cell {
            width: 100%;
            height: 4rem;
            border-bottom: 1px solid #e8e8ea;
        }
        div.record-cell p {margin: 0 0 2px;}

        div.record-cell div.user {text-align: left;}
        div.record-cell div.amount {text-align:center;}
        
        div.user p {font-size: 1.2em;}
        div.user span {color: #8a8b8d;}
        div.amount p {color: #b0b1b3;}
        div.amount span {
            color: #ff8d4e;
            font-size: 1.2em;
        }
        /*债权照片*/
        .photo-cell {
            display: none;
        }
        /*加载提示*/
        .loading-hint {
            padding-top: 25px;
            line-height: 1.2em;
            font-size: 1.2em;
            text-align: center;
            color: grey;
        }
    </style>

    <script>
        /*rem的相对单位定义*/
        var viewportWidth = $(window).width();
        var fontSizeUnit = viewportWidth / 20;
        $("html").css("font-size", fontSizeUnit);

        var finalProfitRate = <%=projectModel.GetFinalProfitRate(projectModel.publish_time.GetValueOrDefault(DateTime.Now).AddDays(projectModel.financing_day))%>;
        var idleMoney = {idle_money};
        var investProgress = {investmentProgress};
        var projectId = {projectModel.id};
        var projectName = '{projectModel.title}';

        function initPage(){
            $('.indicatorContainer').radialIndicator({
                radius: 35,
                barColor: '#fff',
                barBgColor: '#7fd2f0',
                barWidth: 8,
                initValue: investProgress,
                roundCorner : true,
                percentage: true
            });

            $("#btnInvest").click(function() {
                // 初始化投资确认对话框
                var investingValue = Number($(".invest-action input").val());
                if (0 >= investingValue || investingValue % 1 !== 0) {
                    $.dialog.tips("请输入正整数");
                    return;
                } else if (idleMoney < investingValue) {
                    $.dialog.tips("您的余额不足 " + investingValue + " 元");
                    return;
                }
                var profit = finalProfitRate * investingValue;

                var dlg = $("#dlgInvestConfirm");
                dlg.find("#dlgField_InvestAmount").text(investingValue + " 元");
                dlg.find("#dlgField_ProfitPredict").text(profit.toFixed(2) + " 元");
                dlg.find("#dlgField_IdleMoney").text(idleMoney + " 元");
                dlg.find("#dlgField_ProjectName").text(projectName);
                dlg.modal();
            });

            var investActionUrl = "{config.webpath}tools/submit_ajax.ashx?action=invest_project";
            $("#dlgInvestConfirm .btn-primary").click(function() { // 确认投资
                $.post(investActionUrl, {
                    investingAmount: $(".invest-action input").val(),
                    projectId: projectId,
                    transactPassword: $("#transactPwd").val()
                }, function(data) {
                    if (data.status === 0) {
                        $.dialog.alert(data.msg);
                    } else if (data.status === 3) {
                        $.dialog.tips("投资成功！", 2, "32X32/succ.png", function(){
                            location.reload();
                        });
                        //$.dialog.alert(data.msg, function() {
                        //    location.reload();
                        //});
                    } else {
                        $.dialog.tips(data.msg, 2, "32X32/succ.png", function(){
                            location.reload();
                        });
                    }
                }, "json").fail(function(resp) {
                    $.dialog.alert("投资失败，请重试。<br>" + resp.errorMessage);
                });
                return false;
            });
        };
        function initFullpage() {
            $('#fullpage').fullpage({
                paddingBottom: '50px',
                anchors:['project'],
                controlArrows: false,
                verticalCentered: false,
                loopHorizontal: false,
            });
            $.fn.fullpage.setAllowScrolling(false);
            if (!location.hash) {
                if(history.pushState) {
                    history.pushState(null, null, '#project');
                } else {
                    location.href = '#project';
                }
            }
        }
        function initPics() {
            var loadingHintForPics = $(".claims-photos .loading-hint");
            $("div.nav-btns a").click(function () {
                var clickedTab = $(this);
                if (clickedTab.hasClass("nav-active")) return;
                clickedTab.siblings().removeClass("nav-active nav-border-active");
                clickedTab.addClass("nav-active nav-border-active");

                var displayType = clickedTab.attr("data-display-picType");
                $(".photo-cell:not([data-picType=" + displayType + "])").hide();
                var picsShouldShow = $(".photo-cell[data-picType=" + displayType + "]");
                if (picsShouldShow.length === 0) {
                    loadingHintForPics.show();
                } else {
                    loadingHintForPics.hide();
                    picsShouldShow.show();
                }
            });
            $("#spot-pics").click();

            //照片大图弹出
            var zoomingImg = $("#photo-enlarge-dialog img");
            var dlgZooming = $('#photo-enlarge-dialog');
            $("div.photo-cell img").click(function() {
                zoomingImg.attr("src", $(this).attr("data-origin-src"));
                dlgZooming.modal();
            });
        }
        function fixAndroid2xOverflowCannotScroll($affectedElem) {
            var ua = navigator.userAgent;
            if (ua.indexOf("Android") >= 0) {
                var androidversion = parseFloat(ua.slice(ua.indexOf("Android") + 8));
                if (androidversion < 3) {
                    var script = document.createElement('script');
                    script.src = "<%templateskin%>/js/touchscroll.js";
                    script.onload = function () {
                        $affectedElem.each(function(index, elem) {
                            touchScroll(elem);
                        });
                    };
                    document.head.appendChild(script);
                }
            }
        }
        $(function() {
            initPage();
            initPics();
            initFullpage();
            fixAndroid2xOverflowCannotScroll($(".inner-scrollable"));
        });
    </script>
</head>
<body>
<div id="fullpage">
<div class="section">
    <div class="slide">
        <div class="invest-detail-page inner-scrollable">
            <div class="top-screen flex flex--align-items--center flex--column flex--justify-content--space-between">
                <div class="icon-house" style="line-height: 1.5rem">{projectModel.title}</div>
                <div class="indicatorContainer flex flex-center-wrapper"></div>
                <p>还需金额：{investmentBalance}</p>
            </div>
            <div class="invest-data flex">
                <span class="border-right flex flex--column flex-center-wrapper">
                    <span class="title-style">借款金额</span>
                    <p><span class="data-style"><%=string.Format("{0:N0}", projectModel.financing_amount)%></span> 万元</p>
                </span>
                <span class="flex flex--column flex-center-wrapper">
                    <span class="title-style">年化收益</span>
                    <p><span class="data-style"><%=string.Format("{0:0.0}", projectModel.profit_rate_year)%></span> %</p>
                </span>
            </div>
            <div class="invest-data flex">
                <span class="border-right flex flex--column flex-center-wrapper">
                    <span class="title-style">借款期限</span>
                    <p><span class="data-style">{projectModel.repayment_term_span_count}</span> <%=Utils.GetAgp2pEnumDes((Agp2p.Common.Agp2pEnums.ProjectRepaymentTermSpanEnum)projectModel.repayment_term_span)%></p>
                </span>
                <span class="flex flex--column flex-center-wrapper">
                    <span class="title-style">还款方式</span>
                    <p><span><%=projectModel.GetProjectRepaymentTypeDesc()%></span></p>
                </span>
            </div>
            
            <div style="clear:both"></div>
            <div class="account-balance">
                <div class="account-detail">
                    账户余额：<span>{idle_money} 元</span>
                    <a href="<%linkurl("recharge")%>" class="charge-link">[充值]</a>
                </div>
                <div class="invest-action">
                    <%if(projectModel.status<=(int)Agp2pEnums.ProjectStatusEnum.Financing)%>
                    <div class="investing">
                        <input type="text" placeholder="请输入投资金额（大于100）">
                        <button type="button" id="btnInvest">投 资</button>
                    </div>
                    <%else%>
                    <div class="invest-over">
                        <button type="button" class="button-l">已结束</button>
                    </div>
                    <%/if%>
                </div>
            </div>
            <div class="project-content">
                <div class="proj-details" onclick="location.href='#project/details'">项目详情 <span class="glyphicon glyphicon-menu-right"></span></div>
                <div class="invest-record" onclick="location.href='#project/investments'">投资记录 <span class="glyphicon glyphicon-menu-right"></span></div>
                <div class="debt-photos" onclick="location.href='#project/pics'">债权照片 <span class="glyphicon glyphicon-menu-right"></span></div>
                <div class="receive-plan" onclick="location.href='#project/repayTasks'">回款计划 <span class="glyphicon glyphicon-menu-right"></span></div>
            </div>
        </div>
    </div>
    <div class="slide" data-anchor="details">
        <div class="project-detail-page inner-scrollable">
            <div class="borrower">
                <div class="project-detail-title"><span class="title-icon"><span class="blue-mark"></span><span class="orange-mark"></span></span><span class="title-orange">借款人信息</span></div>
                <div class="borrower-info">
                    <ul>
                        <li><span>借款用户： </span><span><%=loaner.dt_users.real_name.Substring(0, 1)+"**"%></span></li>                        
                        <li><span>年龄： </span><span>{loaner.age}</span></li>
                        <li><span>性别： </span><span><%=loaner.dt_users.sex%></span></li>
                        <li><span>籍贯： </span><span>{loaner.native_place}</span></li>
                        <li><span>婚姻状况： </span><span><%=Agp2p.Common.Utils.GetAgp2pEnumDes((Agp2p.Common.Agp2pEnums.MaritalStatusEnum)loaner.marital_status)%></span></li>
                        <li><span>每月收入： </span><span>{loaner.income}</span></li>
                        <li><span>担任职业： </span><span>{loaner.job}</span></li>
                        <li><span>工作地点： </span><span>{loaner.working_at}</span></li>
                    </ul>
                </div>
                <div class="borrower-remark">
                    <p class="remark-style">备注：</p>
                    <span style="display:block;margin-top:0.5rem">{risk.loaner_content}</span>
                </div>
            </div>
            <div class="pawn">
                <div class="project-detail-title"><span class="title-icon"><span class="blue-mark"></span><span class="orange-mark"></span></span><span class="title-orange">抵押物信息</span></div>
                <%foreach(var mortgage in mortgages)%>
                <div class="pawn-info">
                    <ul>
                        <%foreach(var p in GetMortgageProperties(mortgage))%>
                        <li><span><%=p.Item1%>： </span><span><%=p.Item2%></span></li>
                        <%/foreach%>
                    </ul>
                </div>
                <div class="pawn-remark">
                    <p class="remark-style">备注：</p>
                    <span style="display:block;margin-top:0.5rem">{mortgage.remark}</span>
                </div>
                <%/foreach%>
            </div>
            <div class="creditor">
                <div class="project-detail-title"><span class="title-icon"><span class="blue-mark"></span><span class="orange-mark"></span></span><span class="title-orange">债权人信息</span></div>
                <div class="creditor-info">{risk.creditor_content}</div>
            </div>
            <div class="risk-control">
                <div class="project-detail-title"><span class="title-icon"><span class="blue-mark"></span><span class="orange-mark"></span></span><span class="title-orange">风控措施</span></div>
                <div class="risk-control-info">{risk.risk_content}</div>
            </div>
        </div>
    </div>
    <div class="slide" data-anchor="investments">
        <div class="invest-record-page inner-scrollable">
            <%set var investments=QueryProjectTransactions()%>
            <%for(int i=0;i<investments.Count;i++)%>
            <div class="record-cell flex flex--align-items--center flex--flex-grow-first">
                <div class="user">
                    <p><%=investments[i].user_name%></p>
                    <span><%=investments[i].create_time%></span>
                </div>
                <div class="amount">
                    <p>投资金额</p>
                    <span><%=investments[i].value%></span>
                </div>
            </div>
            <%/for%>
        </div>
    </div>
    <div class="slide" data-anchor="pics">
        <div class="claims-photos inner-scrollable">
            <div class="nav-btns">
                <a id="spot-pics" href="javascript:;" data-display-picType="live">现场照片<span class="hr-style">|</span></a>
                <a href="javascript:;" data-display-picType="credit">债权信息<span class="hr-style">|</span></a>
                <a href="javascript:;" data-display-picType="mortgage">合同与凭证</a>
            </div>
            <div class="photos-box">
                <%set var pics = QueryAlbums().ToList()%>
                <%foreach(var picture in pics.Where(a=>a.type==(int)Agp2pEnums.AlbumTypeEnum.Pictures))%>
                <div class="photo-cell" data-picType="live">
                    <img src="{picture.thumb_path}" data-origin-src="{picture.original_path}">
                </div>
                <%/foreach%>
                <%foreach(var picture in pics.Where(a=>a.type==(int)Agp2pEnums.AlbumTypeEnum.PropertyCertificate||a.type==(int)Agp2pEnums.AlbumTypeEnum.LienCertificate))%>
                <div class="photo-cell" data-picType="credit">
                    <img src="{picture.thumb_path}" data-origin-src="{picture.original_path}">
                </div>
                <%/foreach%>
                <%foreach(var picture in pics.Where(a=>a.type==(int)Agp2pEnums.AlbumTypeEnum.LoanAgreement||a.type==(int)Agp2pEnums.AlbumTypeEnum.MortgageContract||a.type==(int)Agp2pEnums.AlbumTypeEnum.IdCard))%>
                <div class="photo-cell" data-picType="mortgage">
                    <img src="{picture.thumb_path}" data-origin-src="{picture.original_path}">
                </div>
                <%/foreach%>
                <div class="loading-hint">
                    <img src="<%templateskin%>/imgs/empty-box.png" style="width:30%;margin:70px auto 10px auto;"/>
                    <p style="color:#ccc">目前没有照片记录</p>
                </div>
            </div>
        </div>
    </div>
    <div class="slide receive-plan-detail-page" data-anchor="repayTasks">
        <%if(!repayment_tasks.Any())%>
        <div class="loading-hint">
            <img src="<%templateskin%>/imgs/empty-box.png" style="width:30%;margin:70px auto 10px auto;"/>
            <p style="color:#ccc">此项目目前没有回款记录</p>
        </div>
        <%/if%>
        <div class="receive-plan-detail-page inner-scrollable">
            <%for(int i=0;i<repayment_tasks.Count;i++)%>
            <%set var task=repayment_tasks[i]%>
            <div class="plan-list flex flex--column flex--justify-content--center">
                <p>第 {task.term} 期回款计划</p>
                <ul>
                    <li>回款利息 <span><%=string.Format("{0:c}", task.repay_interest)%></span></li>
                    <li>回款本金 <span><%=string.Format("{0:c}", task.repay_principal)%></span></li>
                    <li>回款日期 <span><%=task.should_repay_time.ToString("yyyy-MM-dd")%></span></li>
                    <li>回款总额 <span><%=string.Format("{0:c}", task.repay_interest+task.repay_principal)%></span></li>
                </ul>
            </div>
            <%/for%>
        </div>
    </div>
</div>
</div>
    <%template src="_footer.html"%>
    <!-- Modal -->
    <div class="modal fade" id="dlgInvestConfirm" tabindex="-1" role="dialog" aria-labelledby="dlgInvestConfirmLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="dlgInvestConfirmLabel">投资确认</h4>
                </div>
                <div class="modal-body">         
                    <div class="invest-success-page">
                        <div class="congratulation-wrap">
                            <div class="div-center">
                                <p><span id="dlgField_ProjectName"></span></p>
                            </div>
                        </div>
                        <div class="invest-detail-wrap">
                            <ul>
                                <li>
                                    <span>投资金额</span>
                                    <span id="dlgField_InvestAmount"></span>
                                </li>
                                <li>
                                    <span>预计收益</span>
                                    <span id="dlgField_ProfitPredict"></span>
                                </li>
                                <li>
                                    <span>账户余额</span>
                                    <span id="dlgField_IdleMoney"></span>
                                </li>                                
                            </ul>
                            <input type="password" id="transactPwd" class="form-control" placeholder="请输入交易密码">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary">确认投资</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="photo-enlarge-dialog" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="vertical-alignment-helper">
            <div class="modal-dialog vertical-align-center" role="document">
                <div class="modal-content">
                    <div class="photo-enlarge-body">
                        <img src="" data-dismiss="modal">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal end-->
</body>
</html>